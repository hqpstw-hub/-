#!/data/data/com.termux/files/usr/bin/sh

URL_LIST='https://raw.githubusercontent.com/hqpstw-hub/-/refs/heads/main/twTVlist.txt'
SRC='/data/data/com.termux/files/home/twTVlist.txt'
DEST='/sdcard/Download/twTV.m3u'
COOKIE='/data/data/com.termux/files/home/youtube.com_cookies.txt'

# 1. ä¸‹è¼‰èˆ‡ç’°å¢ƒæ¸…ç†
curl -L -k -s "${URL_LIST}?t=$(date +%s)" -o "$SRC"
sed -i 's/\r//g' "$SRC"

echo "#EXTM3U" > "$DEST"
echo "ðŸš€ [å…¨èƒ½è§£æžå™¨ï¼šåˆ†çµ„æ¨™ç±¤ + è¬ç”¨ç¶²å€æ¨¡å¼]"

while read -r line || [ -n "$line" ]; do
    # ç§»é™¤å‰å¾Œç©ºç™½
    line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    [ -z "$line" ] && continue

    # 2. ç°¡æ˜“é‚è¼¯ï¼šåªè¦è¡Œé¦–æ˜¯ # ä¸”ä¸å«é€—è™Ÿï¼Œå°±æ˜¯åˆ†çµ„
    if echo "$line" | grep -q "^#" && ! echo "$line" | grep -q ","; then
        GRP_NAME=$(echo "$line" | tr -d '#')
        echo "ðŸ“ æ•æ‰åˆ†çµ„: $GRP_NAME"
        echo "#EXTGRP:$GRP_NAME" >> "$DEST"
        continue
    fi

    # 3. é »é“è™•ç†ï¼šæå–åç¨±èˆ‡è¬ç”¨ç¶²å€ (XXX://XX.XX/X)
    NAME=$(echo "$line" | cut -d',' -f1)
    LINK=$(echo "$line" | grep -oEi "[a-zA-Z0-9]+://[^.]+\.[^/]+/.+" | head -n 1)

    if [ -n "$LINK" ]; then
        echo "ðŸ“¡ è™•ç†: $NAME"
        if echo "$LINK" | grep -qi "youtube.com"; then
            # YT èµ°è§£æž
            REAL=$(python3 -m yt_dlp --cookies "$COOKIE" -g -f b "$LINK" 2>/dev/null)
            if [ -n "$REAL" ]; then
                echo "#EXTINF:-1,$NAME" >> "$DEST"
                echo "$REAL" >> "$DEST"
            else
                echo "#EXTINF:-1,$NAME [YTè§£æžå¤±æ•—]" >> "$DEST"
                echo "http://0.0.0.0/failed" >> "$DEST"
            fi
        else
            # ç›´é€£ (m3u8ç­‰) ç›´æŽ¥è¼¸å‡º
            echo "#EXTINF:-1,$NAME" >> "$DEST"
            echo "$LINK" >> "$DEST"
        fi
    fi
done < "$SRC"
echo "âœ¨ æˆåŠŸï¼è«‹æª¢æŸ¥ Download/twTV.m3u"
