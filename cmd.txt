#!/data/data/com.termux/files/usr/bin/sh

URL_LIST='https://raw.githubusercontent.com/hqpstw-hub/-/refs/heads/main/twTVlist.txt'
SRC='/data/data/com.termux/files/home/twTVlist.txt'
DEST='/sdcard/Download/twTV.m3u'
COOKIE='/data/data/com.termux/files/home/youtube.com_cookies.txt'

# 1. 強力清洗讀檔：移除所有 Windows 換行符，確保 Linux 讀取順暢
curl -L -k -s "$URL_LIST" -o "$SRC"
sed -i 's/\r//g' "$SRC"

echo "#EXTM3U" > "$DEST"
echo "🚀 [過濾器強化模式啟動...]"

while read -r line; do
    # 移除行首行尾看不見的空白字元
    line=$(echo "$line" | xargs echo -n 2>/dev/null || echo "$line")
    [ -z "$line" ] && continue

    # 2. 暴力保留分組：只要行內包含 #EXTGRP，不論位置，直接寫入
    if echo "$line" | grep -q "#EXTGRP"; then
        echo "📍 捕捉到分組: $line"
        echo "$line" >> "$DEST"
        continue
    fi

    # 3. 頻道解析邏輯
    # 使用 grep 提取第一個符合 YouTube 格式的連結
    LINK=$(echo "$line" | grep -o "https://www.youtube.com/[^ ,]*" | head -n 1)
    # 名稱取第一個逗號前的文字
    NAME=$(echo "$line" | cut -d',' -f1)

    if [ -n "$LINK" ]; then
        echo "📡 正在解析: $NAME"
        REAL=$(python3 -m yt_dlp --cookies "$COOKIE" -g -f b "$LINK" 2>/dev/null)
        
        if [ -n "$REAL" ]; then
            echo "#EXTINF:-1,$NAME" >> "$DEST"
            echo "$REAL" >> "$DEST"
            echo "   ✅ 成功"
        else
            echo "#EXTINF:-1,$NAME [解析失敗]" >> "$DEST"
            echo "http://0.0.0.0/failed" >> "$DEST"
            echo "   ❌ 失敗"
        fi
    fi
done < "$SRC"
echo "✨ 處理完畢！請去檢查電視 App 的分組與清單數量。"
