#!/data/data/com.termux/files/usr/bin/sh

# è¨­å®šè·¯å¾‘
URL_LIST='https://raw.githubusercontent.com/hqpstw-hub/-/refs/heads/main/twTVlist.txt'
SRC='/data/data/com.termux/files/home/twTVlist.txt'
DEST='/sdcard/Download/twTV.m3u'
COOKIE='/data/data/com.termux/files/home/youtube.com_cookies.txt'

# 1. ä¸‹è¼‰èˆ‡æ¸…ç†
curl -L -k -s "${URL_LIST}?t=$(date +%s)" -o "$SRC"
sed -i 's/\r//g' "$SRC"

echo "#EXTM3U" > "$DEST"
echo "ðŸš€ [ç²¾ç°¡æ¨¡å¼å•Ÿå‹•ï¼šç´”æ·¨è§£æž + TiviMate è‡ªå‹•æŽ¥ç®¡]"

CURRENT_GRP="æœªåˆ†é¡ž"

while read -r line || [ -n "$line" ]; do
    line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    [ -z "$line" ] && continue

    # 2. åˆ†çµ„è­˜åˆ¥
    if echo "$line" | grep -q "^#" && ! echo "$line" | grep -q ","; then
        CURRENT_GRP=$(echo "$line" | tr -d '#')
        echo "ðŸ“ ç›®å‰å€åŸŸ: $CURRENT_GRP"
        continue
    fi

    # 3. é »é“è§£æž
    NAME=$(echo "$line" | cut -d',' -f1)
    LINK=$(echo "$line" | grep -oEi "[a-zA-Z0-9]+://[^.]+\.[^/]+/.+" | head -n 1)

    if [ -n "$LINK" ]; then
        if echo "$LINK" | grep -qi "youtube.com"; then
            # YouTube é‚„æ˜¯éœ€è¦ yt-dlp è§£æž REAL URL
            REAL=$(python3 -m yt_dlp --cookies "$COOKIE" -g -f b "$LINK" 2>/dev/null)
        else
            # å…¶ä»–æ‰€æœ‰æºï¼ˆiill.top/4gtv ç­‰ï¼‰å›žæ­¸ç´”æ·¨ç¶²å€
            # ä¸è¦åœ¨ç¶²å€å¾Œé¢æŽ› Headers äº†ï¼Œäº¤çµ¦ TiviMate è¨­å®š
            REAL="$LINK"
        fi

        if [ -n "$REAL" ]; then
            echo "#EXTINF:-1 group-title=\"$CURRENT_GRP\",$NAME" >> "$DEST"
            echo "$REAL" >> "$DEST"
            echo "   âœ… $NAME å·²åŠ å…¥æ¸…å–®"
        fi
    fi
done < "$SRC"

echo "âœ¨ ä»»å‹™å®Œæˆï¼è«‹åœ¨ TiviMate 5.2.0 è¨­å®šä¸­é…ç½® User-Agentã€‚"
