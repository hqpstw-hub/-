#!/data/data/com.termux/files/usr/bin/sh

URL_LIST='https://raw.githubusercontent.com/hqpstw-hub/-/refs/heads/main/twTVlist.txt'
SRC='/data/data/com.termux/files/home/twTVlist.txt'
DEST='/sdcard/Download/twTV.m3u'
LOST='/sdcard/Download/lostlist.txt'
COOKIE='/data/data/com.termux/files/home/youtube.com_cookies.txt'

# 1. ä¸‹è¼‰èˆ‡æ¸…æ´—
curl -L -k -s "${URL_LIST}?t=$(date +%s)" -o "$SRC"
sed -i 's/\r//g' "$SRC"

echo "#EXTM3U" > "$DEST"
echo "--- ğŸ“‹ å¤±æ•ˆæ¸…å–® (è¨˜éŒ„æ—¥æœŸ: $(date)) ---" > "$LOST"
echo "ğŸš€ [å…¨èƒ½è§£æ + æºæª¢æ¸¬æ¨¡å¼å•Ÿå‹•]"

CURRENT_GRP="æœªåˆ†é¡"

while read -r line || [ -n "$line" ]; do
    line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    [ -z "$line" ] && continue

    # 2. åˆ†çµ„è­˜åˆ¥
    if echo "$line" | grep -q "^#" && ! echo "$line" | grep -q ","; then
        CURRENT_GRP=$(echo "$line" | tr -d '#')
        echo "ğŸ“ ç›®å‰å€åŸŸ: $CURRENT_GRP"
        continue
    fi

    # 3. é »é“è§£æèˆ‡ç¶²å€æª¢æ¸¬
    NAME=$(echo "$line" | cut -d',' -f1)
    LINK=$(echo "$line" | grep -oEi "[a-zA-Z0-9]+://[^.]+\.[^/]+/.+" | head -n 1)

    if [ -n "$LINK" ]; then
        echo "ğŸ“¡ æª¢æ¸¬ä¸­: $NAME"
        
        # åˆ¤å®šæ˜¯å¦ç‚º YouTube é€£çµ
        if echo "$LINK" | grep -qi "youtube.com"; then
            REAL=$(python3 -m yt_dlp --cookies "$COOKIE" -g -f b "$LINK" 2>/dev/null)
        else
            REAL="$LINK"
        fi

        # --- æ–¹æ¡ˆ A: è¼•é‡åŒ–æª¢æ¸¬é‚è¼¯ ---
        if [ -n "$REAL" ]; then
            # æ¸¬è©¦é€£çµæ˜¯å¦é€£å¾—é€š (é™æ™‚ 2 ç§’ï¼Œåªå–æ¨™é ­)
            # å¦‚æœæ˜¯ YouTube çš„ REAL é€£çµé€šå¸¸å¾ˆé•·ï¼Œæˆ‘å€‘æ¸¬å®ƒçš„éŸ¿æ‡‰ä»£ç¢¼
            CHECK=$(curl -I -s -m 2 "$REAL" | grep -E "HTTP/.* 200|HTTP/.* 30[12]")
            
            if [ -n "$CHECK" ]; then
                echo "#EXTINF:-1 group-title=\"$CURRENT_GRP\",$NAME" >> "$DEST"
                echo "$REAL" >> "$DEST"
                echo "   âœ… é€šé"
            else
                echo "$NAME,$LINK (é€£ç·šè¶…æ™‚æˆ–å¤±æ•ˆ)" >> "$LOST"
                echo "   âŒ å¤±æ•ˆ (å·²ç§»è‡³ lostlist)"
            fi
        else
            echo "$NAME,$LINK (è§£æå¤±æ•—)" >> "$LOST"
            echo "   âŒ è§£æå¤±æ•— (å·²ç§»è‡³ lostlist)"
        fi
    fi
done < "$SRC"

echo "âœ¨ å®Œæˆï¼"
echo "âœ… æœ‰æ•ˆæº: $DEST"
echo "âš ï¸ å¤±æ•ˆæº: $LOST"
