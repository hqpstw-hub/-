#!/data/data/com.termux/files/usr/bin/sh

# 設定路徑
URL_LIST='https://raw.githubusercontent.com/hqpstw-hub/-/refs/heads/main/twTVlist.txt'
SRC='/data/data/com.termux/files/home/twTVlist.txt'
DEST='/sdcard/Download/twTV.m3u'
COOKIE='/data/data/com.termux/files/home/youtube.com_cookies.txt'

# 1. 下載最新清單 (加上時間戳破除快取)
curl -L -k -s "${URL_LIST}?t=$(date +%s)" -o "$SRC"

# 2. 強制清洗格式：移除 Windows 換行符並確保編碼正確
sed -i 's/\r//g' "$SRC"

echo "#EXTM3U" > "$DEST"
echo "🚀 [啟動解析，目前清單行數: $(wc -l < $SRC)]"

while read -r line || [ -n "$line" ]; do
    # 移除行首尾空白
    line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    [ -z "$line" ] && continue

    # 3. 識別分組標籤 (#EXTGRP)
    if echo "$line" | grep -qi "#EXTGRP"; then
        echo "📍 發現分組: $line"
        echo "$line" >> "$DEST"
        continue
    fi

    # 4. 提取名稱與 YouTube 連結
    NAME=$(echo "$line" | cut -d',' -f1)
    LINK=$(echo "$line" | grep -o "https://www.youtube.com/[^ ,]*")

    if [ -n "$LINK" ]; then
        echo "📡 解析中: $NAME"
        # 執行解析
        REAL=$(python3 -m yt_dlp --cookies "$COOKIE" -g -f b "$LINK" 2>/dev/null)
        
        if [ -n "$REAL" ]; then
            echo "#EXTINF:-1,$NAME" >> "$DEST"
            echo "$REAL" >> "$DEST"
        else
            echo "#EXTINF:-1,$NAME [解析失敗]" >> "$DEST"
            echo "http://0.0.0.0/failed" >> "$DEST"
        fi
    fi
done < "$SRC"
echo "✨ 任務完成！清單已輸出至 Download 資料夾。"
