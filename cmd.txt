#!/data/data/com.termux/files/usr/bin/sh

URL_LIST='https://raw.githubusercontent.com/hqpstw-hub/-/refs/heads/main/twTVlist.txt'
SRC='/data/data/com.termux/files/home/twTVlist.txt'
DEST='/sdcard/Download/twTV.m3u'
COOKIE='/data/data/com.termux/files/home/youtube.com_cookies.txt'

echo "--- ğŸ› ï¸ é€²å…¥é™¤éŒ¯æ¨¡å¼ ---"

# 1. ä¸‹è¼‰ä¸¦ç ´é™¤å¿«å–
echo "ğŸ“¡ æ­£åœ¨å¾ GitHub æŠ“å–æ¸…å–®..."
TIMESTAMP=$(date +%s)
curl -L -k -v -s "${URL_LIST}?t=${TIMESTAMP}" -o "$SRC"

echo "ğŸ“Š ä¸‹è¼‰å®Œæˆï¼Œæœ¬åœ°æª”æ¡ˆå¤§å°: $(du -h $SRC | cut -f1)"
echo "ğŸ“ æª”æ¡ˆå…§å®¹å‰ 5 è¡Œé è¦½ï¼š"
head -n 5 "$SRC"
echo "----------------------"

# 2. æ¸…æ´—æ ¼å¼
echo "ğŸ§¼ æ­£åœ¨åŸ·è¡Œ sed æ¸…æ´— (ç§»é™¤ \r)..."
sed -i 's/\r//g' "$SRC"
TOTAL_LINES=$(wc -l < "$SRC")
echo "ğŸ“ˆ æ¸…æ´—å¾Œç¸½è¡Œæ•¸: $TOTAL_LINES"

echo "#EXTM3U" > "$DEST"

# 3. é€è¡Œè§£æèˆ‡åˆ¤å®š
COUNT=0
while read -r line || [ -n "$line" ]; do
    COUNT=$((COUNT+1))
    
    # éæ¿¾ç©ºè¡Œ
    CLEAN_LINE=$(echo "$line" | tr -d '[:space:]')
    if [ -z "$CLEAN_LINE" ]; then
        continue
    fi

    # åˆ¤å®šæ˜¯å¦ç‚ºåˆ†çµ„
    if echo "$line" | grep -qi "#EXTGRP"; then
        echo "ğŸ“ [ç¬¬ $COUNT è¡Œ] åˆ¤å®šç‚ºåˆ†çµ„: $line"
        echo "$line" >> "$DEST"
        continue
    fi

    # åˆ¤å®šæ˜¯å¦ç‚ºé »é“
    NAME=$(echo "$line" | cut -d',' -f1)
    LINK=$(echo "$line" | grep -o "https://www.youtube.com/[^ ,]*")

    if [ -n "$LINK" ]; then
        echo "ğŸ“¡ [ç¬¬ $COUNT è¡Œ] åˆ¤å®šç‚ºé »é“: $NAME"
        REAL=$(python3 -m yt_dlp --cookies "$COOKIE" -g -f b "$LINK" 2>/dev/null)
        
        if [ -n "$REAL" ]; then
            echo "#EXTINF:-1,$NAME" >> "$DEST"
            echo "$REAL" >> "$DEST"
            echo "   âœ… è§£ææˆåŠŸ"
        else
            echo "#EXTINF:-1,$NAME [è§£æå¤±æ•—]" >> "$DEST"
            echo "http://0.0.0.0/failed" >> "$DEST"
            echo "   âŒ yt-dlp æŠ“ä¸åˆ°ç¶²å€"
        fi
    else
        echo "âš ï¸ [ç¬¬ $COUNT è¡Œ] ç„¡æ³•è­˜åˆ¥çš„æ ¼å¼: $line"
    fi
done < "$SRC"

echo "--- ğŸ é™¤éŒ¯çµæŸ ---"
echo "æœ€çµ‚è¼¸å‡ºæª”æ¡ˆ: $DEST"
echo "ç”¢ç”Ÿçš„ M3U è¡Œæ•¸: $(wc -l < $DEST)"
