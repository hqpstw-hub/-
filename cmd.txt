#!/data/data/com.termux/files/usr/bin/sh

URL_LIST='https://raw.githubusercontent.com/hqpstw-hub/-/refs/heads/main/twTVlist.txt'
SRC='/data/data/com.termux/files/home/twTVlist.txt'
DEST='/sdcard/Download/twTV.m3u'
COOKIE='/data/data/com.termux/files/home/youtube.com_cookies.txt'

echo "--- ğŸ› ï¸ è¬ç”¨æ ¼å¼é™¤éŒ¯æ¨¡å¼ ---"

# 1. ä¸‹è¼‰èˆ‡æ¸…æ´—
curl -L -k -s "${URL_LIST}?t=$(date +%s)" -o "$SRC"
sed -i 's/\r//g' "$SRC"
echo "ğŸ“ˆ è®€å–ç¸½è¡Œæ•¸: $(wc -l < "$SRC")"

echo "#EXTM3U" > "$DEST"

while read -r line || [ -n "$line" ]; do
    line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    [ -z "$line" ] && continue

    # A. åˆ¤æ–·åˆ†çµ„ï¼šåŒ…å« #EXTGRP æˆ– [æ–‡å­—] æ ¼å¼
    if echo "$line" | grep -qi "#EXTGRP" || echo "$line" | grep -q "^\[.*\]$"; then
        echo "ğŸ“ æ•æ‰åˆ†çµ„: $line"
        # å¦‚æœæ˜¯ [æ–°è] æ ¼å¼ï¼Œè½‰æ›æˆæ¨™æº– #EXTGRP æ ¼å¼ä»¥åˆ©æ’­æ”¾å™¨è­˜åˆ¥
        CLEAN_GRP=$(echo "$line" | tr -d '[]')
        echo "#EXTGRP:$CLEAN_GRP" >> "$DEST"
        continue
    fi

    # B. è¬ç”¨ç¶²å€æå–é‚è¼¯ (ç¬¦åˆ XXX://XX.XX/X çµæ§‹)
    # æ­¤æ­£å‰‡ç¢ºä¿æœ‰å”å®šã€æœ‰ç¶²åŸŸé»ã€æœ‰å¾ŒçºŒè·¯å¾‘
    LINK=$(echo "$line" | grep -oEi "[a-zA-Z0-9]+://[^.]+\.[^/]+/.+" | head -n 1)
    NAME=$(echo "$line" | cut -d',' -f1)

    if [ -n "$LINK" ]; then
        echo "ğŸ“¡ è™•ç†é »é“: $NAME"
        
        if echo "$LINK" | grep -qi "youtube.com"; then
            # YouTube èµ°è§£ææµç¨‹
            REAL=$(python3 -m yt_dlp --cookies "$COOKIE" -g -f b "$LINK" 2>/dev/null)
            if [ -n "$REAL" ]; then
                echo "#EXTINF:-1,$NAME" >> "$DEST"
                echo "$REAL" >> "$DEST"
                echo "   âœ… YT è§£ææˆåŠŸ"
            else
                echo "#EXTINF:-1,$NAME [YTè§£æå¤±æ•—]" >> "$DEST"
                echo "http://0.0.0.0/failed" >> "$DEST"
                echo "   âŒ YT è§£æå¤±æ•—"
            fi
        else
            # é YouTube (å¦‚ .m3u8) ç›´æ¥å¯«å…¥ï¼Œä¸éœ€è§£æ
            echo "#EXTINF:-1,$NAME" >> "$DEST"
            echo "$LINK" >> "$DEST"
            echo "   ğŸ”— ç›´é€£ç¶²å€å·²åŠ å…¥"
        fi
    else
        echo "âš ï¸ ç„¡æ³•è­˜åˆ¥: $line"
    fi
done < "$SRC"

echo "--- ğŸ ä»»å‹™å®Œæˆ ---"
echo "ç”¢ç”Ÿçš„ M3U ç¸½è¡Œæ•¸: $(wc -l < $DEST)"
